#!/usr/bin/env ruby

require 'optparse'

local_casserver = File.expand_path(File.dirname(File.expand_path(__FILE__))+'/../lib/casserver.rb')
if File.exists? local_casserver
  $: << File.dirname(local_casserver)
else
  require 'rubygems'
  require_gem 'rubycas-server'
end

OptionParser.new do |opts|
  opts.banner = "Usage: rubycas-server [options]"

  opts.on("-c", "--config FILE", "Use config file (default is /etc/rubycas-server/config.yml)") do |c|
  	puts "Using config file #{c}"
    $CONFIG_FILE = c
  end
  
  opts.on("-d", "--daemonize", "Run as a daemon (only when using webrick or mongrel)") do |c|
    $DAEMONIZE = true
  end

  opts.on("-P", "--pid_file FILE", "Use pid file (default is /etc/rubycas-server/rubycas-server.pid)") do |c|
    if $DAEMONIZE && !File.exists?(c)
      puts "Using pid file #{c}"
      $PID_FILE = c
    elsif File.exists?(c)
      puts "The pid file already exists.  Is rubycas-server running?"
      exit
    else
      puts "Not running as Daemon.  Ignoring pid option"
    end
  end

  opts.on_tail("-h", "--help", "Show this message") do
    puts opts
    exit
  end
  
  opts.on_tail("-v", "--version", "Show version number") do
  	require 'casserver/version'
    puts "rubycas-server-#{CASServer::VERSION::STRING}"
    exit
  end
end.parse!

$RUN = true

load 'casserver.rb'
